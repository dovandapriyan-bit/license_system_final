<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>License Center — Admin Dashboard (Full)</title>
<style>
  :root{
    --bg:#f7f9fb; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --danger:#dc2626;
    --ok:#16a34a; --glass: rgba(0,0,0,0.04);
  }
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
  header{background:linear-gradient(90deg,#fff,#f8fafc);padding:16px 22px;border-bottom:1px solid #e6eef8;display:flex;align-items:center;gap:14px}
  .brand{font-weight:700;color:var(--accent);font-size:18px}
  .sub{color:var(--muted);font-size:13px}
  .wrap{max-width:1200px;margin:22px auto;padding:0 18px}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
  input[type="text"], input[type="date"], select {padding:10px 12px;border:1px solid #e6eef8;border-radius:8px;background:var(--card);min-width:180px}
  button{background:var(--accent);color:white;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(37,99,235,0.12)}
  .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(16,24,40,0.04);margin-bottom:14px;border:1px solid var(--glass)}
  .project-header{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:12px}
  .project-name{font-weight:700;color:#0f172a}
  .stats{display:flex;gap:8px;align-items:center;font-size:13px}
  .stat{background:#f3f7ff;padding:6px 8px;border-radius:8px;color:#0f172a}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px 8px;text-align:left;border-bottom:1px solid #f1f5f9}
  th{color:#334155;font-size:13px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace;color:#0f172a}
  .tag{padding:6px 8px;border-radius:999px;font-weight:600;font-size:12px}
  .tag.trial{background:#fff7ed;color:#b45309;border:1px solid rgba(180,83,9,0.08)}
  .tag.basic{background:#eef2ff;color:#3730a3;border:1px solid rgba(55,48,163,0.08)}
  .tag.premium{background:#ecfdf5;color:#065f46;border:1px solid rgba(6,95,70,0.08)}
  .btn-edit{background:#f8fafc;color:#334155;border:1px solid #e6eef8;padding:6px 8px;border-radius:8px;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  .danger{color:var(--danger);font-weight:700}
  .ok{color:var(--ok);font-weight:700}
  .right{margin-left:auto}
  .hidden{display:none !important}
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal{width:760px;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 20px 40px rgba(2,6,23,0.15)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
  .muted{color:var(--muted);font-size:13px}
  .searchbox{flex:1;min-width:240px}
  @media (max-width:900px){ .modal{width:92%} .grid{grid-template-columns:1fr}}
  .codeBox{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:#f7fbff;border:1px solid #e6f0ff}
  .copyBtn{background:#0f172a;color:#fff;padding:6px 8px;border-radius:6px;border:0;cursor:pointer}
</style>
</head>
<body>
<header>
  <div style="display:flex;flex-direction:column">
    <div class="brand">License Center — Admin</div>
    <div class="sub">Central management for all project licenses</div>
  </div>
</header>

<div class="wrap">
  <!-- Controls + Create License Form -->
  <div class="card">
    <div style="display:flex;align-items:flex-start;gap:18px;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <div class="small muted">Project</div>
        <select id="projectSelect" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:#fff">
          <option value="">-- Pilih project (atau tulis nama baru) --</option>
        </select>
        <input id="projectNameInput" type="text" placeholder="(opsional) Isi untuk membuat project baru" style="margin-top:8px" />
      </div>

      <div style="min-width:220px">
        <div class="small muted">User ID / Nomor HP</div>
        <input id="newUserId" type="text" placeholder="contoh: 0812xxxxxxx" />
      </div>

      <div style="min-width:170px">
        <div class="small muted">Paket</div>
        <select id="newPlan">
          <option value="trial">trial</option>
          <option value="basic">basic</option>
          <option value="premium">premium</option>
        </select>
      </div>

      <div style="min-width:170px">
        <div class="small muted">Expires (opsional)</div>
        <input id="newExpire" type="date" />
      </div>

      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="small muted">&nbsp;</div>
        <div style="display:flex;gap:8px">
          <button id="createLicenseBtn">Generate & Simpan</button>
          <button id="generateOnlyBtn" class="ghost">Generate Kode Saja</button>
        </div>
        <div id="createMsg" class="small" style="margin-top:6px"></div>
        <div id="generatedCodeBox" class="codeBox hidden" style="margin-top:8px">
          <div>
            <div class="small muted">Kode Lisensi:</div>
            <div id="generatedCode" class="mono" style="font-weight:700;font-size:16px">XXXX-XXXX-XXXX</div>
          </div>
          <div style="margin-left:auto">
            <button id="copyGenerated" class="copyBtn">Copy</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search + actions -->
  <div class="controls">
    <input id="searchInput" class="searchbox" type="text" placeholder="Search project name or username..." />
    <select id="filterPlan"><option value="">All plans</option><option value="trial">trial</option><option value="basic">basic</option><option value="premium">premium</option></select>
    <button id="refreshBtn" class="ghost">Refresh</button>
    <button id="downloadBackupBtn">Download Latest Backup</button>
    <div style="margin-left:auto" class="small">Auto-backup: <span id="backupStatus">—</span></div>
  </div>

  <!-- Projects list -->
  <div id="projectsContainer"></div>
</div>

<!-- Edit modal - DIPASTIKAN TIDAK MUNCUL -->
<div id="modalBackdrop" class="modal-backdrop hidden">
  <div class="modal">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <div style="font-weight:700;font-size:16px">Edit License</div>
      <div class="small muted">modify user license details</div>
    </div>
    <div class="grid">
      <div class="field">
        <label class="muted">Project</label>
        <div id="modalProjectName" class="small"></div>
      </div>
      <div class="field">
        <label class="muted">User ID</label>
        <div id="modalUserId" class="small mono"></div>
      </div>
      <div class="field">
        <label class="muted">Plan</label>
        <select id="modalPlan"><option value="trial">trial</option><option value="basic">basic</option><option value="premium">premium</option></select>
      </div>
      <div class="field">
        <label class="muted">Status</label>
        <select id="modalStatus"><option value="active">active</option><option value="nonactive">nonactive</option><option value="expired">expired</option></select>
      </div>
      <div class="field" style="grid-column:1/3">
        <label class="muted">Expires at</label>
        <input id="modalExpire" type="date" />
      </div>
      <div class="field" style="grid-column:1/3">
        <label class="muted">License Code</label>
        <input id="modalCode" type="text" />
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="modalCancel" class="ghost">Cancel</button>
      <button id="modalSave">Save changes</button>
    </div>
  </div>
</div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ----------------- FIREBASE CONFIG ----------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAbjTvpPZrghmkBEM9gsuzJnxrW3CpvKtk",
  authDomain: "license-system-final.firebaseapp.com",
  projectId: "license-system-final",
  storageBucket: "license-system-final.firebasestorage.app",
  messagingSenderId: "1015431823618",
  appId: "1:1015431823618:web:5c1f0dceaf573b163fc21b",
  measurementId: "G-MM848C9R7H"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* UI refs */
const projectSelect = document.getElementById('projectSelect');
const projectNameInput = document.getElementById('projectNameInput');
const newUserId = document.getElementById('newUserId');
const newPlan = document.getElementById('newPlan');
const newExpire = document.getElementById('newExpire');
const createLicenseBtn = document.getElementById('createLicenseBtn');
const generateOnlyBtn = document.getElementById('generateOnlyBtn');
const createMsg = document.getElementById('createMsg');
const generatedCodeBox = document.getElementById('generatedCodeBox');
const generatedCodeEl = document.getElementById('generatedCode');
const copyGenerated = document.getElementById('copyGenerated');

const searchInput = document.getElementById('searchInput');
const filterPlan = document.getElementById('filterPlan');
const refreshBtn = document.getElementById('refreshBtn');
const downloadBackupBtn = document.getElementById('downloadBackupBtn');
const backupStatusEl = document.getElementById('backupStatus');

const projectsContainer = document.getElementById('projectsContainer');

const modalBackdrop = document.getElementById('modalBackdrop');
const modalProjectName = document.getElementById('modalProjectName');
const modalUserId = document.getElementById('modalUserId');
const modalPlan = document.getElementById('modalPlan');
const modalStatus = document.getElementById('modalStatus');
const modalExpire = document.getElementById('modalExpire');
const modalCode = document.getElementById('modalCode');
const modalCancel = document.getElementById('modalCancel');
const modalSave = document.getElementById('modalSave');

let allProjects = [];
let lastBackupAt = 0;
const DEBOUNCE_MS = 1200;

/* Helpers */
function toDateInputVal(d){
  if(!d) return "";
  const dt = (d && d.toDate) ? d.toDate() : new Date(d);
  const y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), day = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function toReadable(d){
  if(!d) return '-';
  const dt = (d && d.toDate)? d.toDate() : new Date(d);
  return dt.toLocaleDateString();
}
function daysRemaining(d){
  if(!d) return -1;
  const dt = (d && d.toDate)? d.toDate() : new Date(d);
  const diff = Math.ceil((dt - new Date())/(1000*60*60*24));
  return diff;
}
function genCode(){
  const seg = ()=> Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(2,6);
  return `${seg()}-${seg()}-${seg()}`;
}

/* UI: copy generated */
copyGenerated.addEventListener('click', ()=>{
  const code = generatedCodeEl.textContent.trim();
  navigator.clipboard.writeText(code).then(()=> {
    copyGenerated.textContent = 'Copied';
    setTimeout(()=> copyGenerated.textContent = 'Copy',1000);
  }).catch(()=>{ copyGenerated.textContent = 'Fail'; setTimeout(()=> copyGenerated.textContent = 'Copy',1000); });
});

/* Render dropdown */
function renderProjectDropdown(){
  projectSelect.innerHTML = `<option value="">-- Pilih project (atau isi nama baru di bawah) --</option>`;
  allProjects.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.data.name || p.id;
    projectSelect.appendChild(opt);
  });
}

/* Render projects list */
function renderProjects(){
  const q = (searchInput.value||'').trim().toLowerCase();
  const planFilter = filterPlan.value;
  if(!allProjects.length) {
    projectsContainer.innerHTML = `<div class="card"><div class="small">No projects</div></div>`;
    return;
  }
  let html = '';
  allProjects.forEach(p=>{
    const id = p.id;
    const d = p.data;
    const projName = d.name || id;
    const usersObj = d.users || {};
    const userRows = Object.entries(usersObj).map(([uid,u])=>{
      const exp = u.expiresAt ? (u.expiresAt.toDate ? u.expiresAt.toDate() : new Date(u.expiresAt)) : null;
      return { uid, plan: u.plan||'-', status: u.status||'-', expiresAt: exp, remaining: daysRemaining(exp), licenseCode: u.licenseCode||'-' };
    });
    
    const matchesProject = projName.toLowerCase().includes(q);
    const matchesAnyUser = userRows.some(r => r.uid.toLowerCase().includes(q));
    if(q && !(matchesProject || matchesAnyUser)) return;
    
    const rowsFiltered = planFilter ? userRows.filter(r => r.plan === planFilter) : userRows;

    let total=0, active=0, expired=0, trial=0, basic=0, premium=0;
    userRows.forEach(r=>{ total++; if(r.status==='active') active++; if(r.status==='expired') expired++; if(r.plan==='trial') trial++; if(r.plan==='basic') basic++; if(r.plan==='premium') premium++; });

    const usersHtml = rowsFiltered.length ? rowsFiltered.map(r=>{
      const remainClass = (r.remaining <= 3 && r.remaining >= 0) ? 'style="color:var(--danger);font-weight:700"' : (r.remaining < 0 ? 'class="small"' : '');
      const tag = r.plan==='trial' ? 'trial' : r.plan==='basic' ? 'basic' : 'premium';
      return `<tr>
        <td class="mono">${r.uid}</td>
        <td><span class="tag ${tag}">${r.plan}</span></td>
        <td>${r.status}</td>
        <td>${r.expiresAt ? toReadable(r.expiresAt) : '-'}</td>
        <td ${remainClass}>${r.remaining>=0 ? r.remaining + ' hari' : 'expired'}</td>
        <td class="mono">${r.licenseCode}</td>
        <td style="text-align:right"><button class="btn-edit" data-project="${id}" data-user="${r.uid}">Edit</button></td>
      </tr>`;
    }).join('') : `<tr><td colspan="7" class="small">No users matching filter</td></tr>`;

    html += `
      <div class="card">
        <div class="project-header">
          <div>
            <div class="project-name">${projName}</div>
            <div class="small muted">ID: ${id}</div>
          </div>
          <div class="stats">
            <div class="stat">Total ${total}</div>
            <div class="stat">Active ${active}</div>
            <div class="stat">Expired ${expired}</div>
            <div class="stat">Trial ${trial}</div>
            <div class="stat">Basic ${basic}</div>
            <div class="stat">Premium ${premium}</div>
          </div>
        </div>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>User ID</th><th>Plan</th><th>Status</th><th>Expires</th><th>Sisa Hari</th><th>License Code</th><th style="text-align:right">Aksi</th></tr></thead>
            <tbody>${usersHtml}</tbody>
          </table>
        </div>
      </div>`;
  });

  projectsContainer.innerHTML = html || `<div class="card"><div class="small">No projects to display</div></div>`;
  
  // Attach edit handlers
  document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', ()=> {
      const pr = btn.getAttribute('data-project');
      const us = btn.getAttribute('data-user');
      openEdit(pr, us);
    });
  });
}

/* Generate only */
generateOnlyBtn.addEventListener('click', ()=>{
  const code = genCode();
  generatedCodeEl.textContent = code;
  generatedCodeBox.classList.remove('hidden');
});

/* Create license */
createLicenseBtn.addEventListener('click', async ()=>{
  createMsg.textContent = 'Processing...';
  const selectedProject = projectSelect.value;
  const projectNameCustom = projectNameInput.value.trim();
  const userIdVal = newUserId.value.trim();
  const planVal = newPlan.value;
  const expireVal = newExpire.value;

  if(!userIdVal){ createMsg.textContent = 'Masukkan User ID.'; return; }

  let projectId = selectedProject || (projectNameCustom ? projectNameCustom.trim().replace(/\s+/g,'-').toLowerCase() : '');
  if(!projectId){
    createMsg.textContent = 'Pilih project atau isi nama project baru.';
    return;
  }

  try {
    const projRef = db.collection('projects').doc(projectId);
    const projSnap = await projRef.get();
    let defaultDuration = { trial:7, basic:30, premium:365 };
    if (projSnap.exists && projSnap.data().defaultDuration) defaultDuration = projSnap.data().defaultDuration;

    let expiresAt = null;
    if (expireVal) {
      const dt = new Date(expireVal + 'T23:59:59');
      expiresAt = firebase.firestore.Timestamp.fromDate(dt);
    } else {
      const dt = new Date();
      dt.setDate(dt.getDate() + (defaultDuration[planVal] || 0));
      expiresAt = firebase.firestore.Timestamp.fromDate(dt);
    }

    const licenseCode = genCode();
    const userObj = {
      plan: planVal,
      status: "active",
      licenseCode: licenseCode,
      expiresAt: expiresAt,
      generatedAt: firebase.firestore.Timestamp.fromDate(new Date())
    };

    if(projSnap.exists){
      const users = projSnap.data().users || {};
      users[userIdVal] = userObj;
      await projRef.update({ users });
    } else {
      const nameToSave = projectNameCustom || projectId;
      await projRef.set({ name: nameToSave, defaultDuration: defaultDuration, users: { [userIdVal]: userObj } });
    }

    generatedCodeEl.textContent = licenseCode;
    generatedCodeBox.classList.remove('hidden');
    createMsg.textContent = '✅ Lisensi dibuat & disimpan.';
    newUserId.value = '';
    projectNameInput.value = '';
    triggerImmediateBackup(`create:${projectId}:${userIdVal}`);
  } catch (e) {
    console.error(e);
    createMsg.textContent = 'Gagal menyimpan. Lihat console.';
  }
});

/* ===== MODAL FUNCTIONS ===== */
function openEdit(projectId, userId){
  const proj = allProjects.find(p => p.id === projectId);
  if(!proj) return alert('Project not found');
  const user = (proj.data.users || {})[userId] || {};
  modalProjectName.textContent = proj.data.name || projectId;
  modalUserId.textContent = userId;
  modalPlan.value = user.plan || 'basic';
  modalStatus.value = user.status || 'active';
  modalExpire.value = toDateInputVal(user.expiresAt);
  modalCode.value = user.licenseCode || '';
  
  modalBackdrop.classList.remove('hidden');
}

function closeModal(){
  modalBackdrop.classList.add('hidden');
}

modalCancel.addEventListener('click', closeModal);
modalBackdrop.addEventListener('click', (e) => {
  if (e.target === modalBackdrop) {
    closeModal();
  }
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && !modalBackdrop.classList.contains('hidden')) {
    closeModal();
  }
});

modalSave.addEventListener('click', async ()=>{
  const projectId = modalState.projectId;
  const userId = modalState.userId;
  if(!projectId || !userId) return;
  
  const newPlanVal = modalPlan.value;
  const newStatus = modalStatus.value;
  const newExpireVal = modalExpire.value;
  const newCode = modalCode.value.trim() || null;
  
  const projRef = db.collection('projects').doc(projectId);
  const updates = {};
  updates[`users.${userId}.plan`] = newPlanVal;
  updates[`users.${userId}.status`] = newStatus;
  updates[`users.${userId}.licenseCode`] = newCode;
  
  if(newExpireVal){
    const dt = new Date(newExpireVal + 'T23:59:59');
    updates[`users.${userId}.expiresAt`] = firebase.firestore.Timestamp.fromDate(dt);
  } else {
    updates[`users.${userId}.expiresAt`] = null;
  }
  
  try {
    await projRef.update(updates);
    closeModal();
    triggerImmediateBackup(`edit:${projectId}:${userId}`);
  } catch (e) {
    console.error(e);
    alert('Update failed, check console');
  }
});

/* Backup functions */
let extTimer = null;
async function backupProjects(){
  try {
    const snap = await db.collection('projects').get();
    const data = snap.docs.map(d => {
      const obj = d.data();
      const users = {};
      if(obj.users){
        Object.entries(obj.users).forEach(([uid,u])=>{
          users[uid] = {
            plan: u.plan||null,
            status: u.status||null,
            licenseCode: u.licenseCode||null,
            expiresAt: u.expiresAt && u.expiresAt.toDate ? u.expiresAt.toDate().toISOString() : (u.expiresAt || null),
            generatedAt: u.generatedAt && u.generatedAt.toDate ? u.generatedAt.toDate().toISOString() : (u.generatedAt || null)
          };
        });
      }
      return { id: d.id, name: obj.name||d.id, defaultDuration: obj.defaultDuration||null, users };
    });
    await db.collection('backup_projects').add({ createdAt: firebase.firestore.FieldValue.serverTimestamp(), source: 'dashboard-auto', data });
    lastBackupAt = Date.now();
    backupStatusEl.textContent = new Date().toLocaleString();
  } catch (e) {
    console.error('backup failed', e);
    backupStatusEl.textContent = 'backup failed';
  }
}

function scheduleBackupDebounced(){
  if(extTimer) clearTimeout(extTimer);
  extTimer = setTimeout(()=> {
    if(Date.now() - lastBackupAt < 1000) return;
    backupProjects();
  }, DEBOUNCE_MS);
}

function triggerImmediateBackup(reason){
  if(Date.now() - lastBackupAt < 800) return;
  backupProjects();
}

/* Start listener */
function startListener(){
  db.collection('projects').onSnapshot(snapshot=>{
    allProjects = snapshot.docs.map(d => ({ id: d.id, data: d.data(), raw: d }));
    renderProjectDropdown();
    renderProjects();
    scheduleBackupDebounced();
  }, err => {
    console.error('onSnapshot error', err);
    projectsContainer.innerHTML = `<div class="card"><div class="small">Failed to load projects: ${err.message}</div></div>`;
  });
}

/* Event listeners */
downloadBackupBtn.addEventListener('click', async ()=>{
  try {
    const snaps = await db.collection('backup_projects').orderBy('createdAt','desc').limit(1).get();
    if(snaps.empty){ alert('No backup found'); return; }
    const doc = snaps.docs[0].data();
    const blob = new Blob([JSON.stringify(doc, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'latest_backup.json'; a.click();
  } catch (e) {
    console.error(e); alert('Failed to download backup');
  }
});

refreshBtn.addEventListener('click', ()=> renderProjects());
searchInput.addEventListener('input', ()=> renderProjects());
filterPlan.addEventListener('change', ()=> renderProjects());

/* Initialize */
startListener();

window.addEventListener('load', ()=> setTimeout(()=> { 
  if(Date.now() - lastBackupAt > 3000) backupProjects(); 
}, 1200));
</script>
</body>
</html>